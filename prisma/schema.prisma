// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["fullTextSearch"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid()) @db.Uuid
  email         String    @unique
  passwordHash  String?   @map("password_hash")
  role          String    @default("user") // 'user', 'admin'
  status        String    @default("active") // 'active', 'suspended'
  averageRating Float?    @default(0) @map("average_rating")
  totalReviews  Int       @default(0) @map("total_reviews")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Verification & Onboarding Fields
  firstName           String?
  lastName            String?
  onboardingCompleted Boolean @default(false)
  isEmailVerified     Boolean @default(false) @map("is_email_verified")
  isVerified          Boolean @default(false) // Identity verified
  verificationStatus  String  @default("NONE") // PENDING, VERIFIED, REJECTED, NONE
  phoneNumber         String?
  supabaseUserId      String? @unique @map("supabase_user_id")
  
  // Identity Documents
  idDocumentType      String? // 'government_id', 'student_id', 'passport', 'drivers_license'
  idDocumentFrontUrl  String?
  idDocumentBackUrl   String?
  faceVerificationUrl String?
  rejectionReason     String?

  // Real Location
  locationLat     Float?
  locationLng     Float?
  locationAddress String?
  city            String?
  state           String?

  profile       UserProfile?
  listings      Listing[]
  barterOffersMade BarterOffer[] @relation("BuyerOffers")
  barterOffersReceived BarterOffer[] @relation("SellerOffers")
  carts         Cart[]
  ordersBought  Order[] @relation("BuyerOrders")
  ordersSold    Order[] @relation("SellerOrders")
  conversationsStarted Conversation[] @relation("BuyerConversations")
  conversationsReceived Conversation[] @relation("SellerConversations")
  messages      Message[]
  notifications Notification[]
  reportsMade   Report[] @relation("Reporter")
  reportsAgainst Report[] @relation("ReportedUser")
  reportsResolved Report[] @relation("AdminResolver")
  recentlyViewed RecentlyViewed[]
  wants         Want[]
  reviewsGiven  Review[] @relation("ReviewsGiven")
  reviewsReceived Review[] @relation("ReviewsReceived")
  appeals       Appeal[] @relation("UserAppeals")
  appealsReviewed Appeal[] @relation("AdminReviewedAppeals")
  disputesFiled    Dispute[] @relation("DisputeReporter")
  disputesResolved Dispute[] @relation("DisputeResolver")

  // OAuth fields
  googleId      String? @unique @map("google_id")
  
  // Password reset
  passwordResetToken   String? @map("password_reset_token")
  passwordResetExpires DateTime? @map("password_reset_expires") @db.Timestamptz

  // RBAC Fields
  roleId        String?   @map("role_id") @db.Uuid
  userRole      Role?     @relation(fields: [roleId], references: [id])
  twoFactorSecret String? @map("two_factor_secret")

  auditLogs     AuditLog[] @relation("AuditLogUser")
  auditTargets  AuditLog[] @relation("AuditLogTarget")
  deviceFingerprints DeviceFingerprint[]
  promotionsCreated PromotedListing[]

  signupIpAddress String? @map("signup_ip_address")
  lastLoginIp     String? @map("last_login_ip")

  // Login security
  failedLoginAttempts Int       @default(0) @map("failed_login_attempts")
  lockoutUntil        DateTime? @map("lockout_until") @db.Timestamptz

  // Monetization Fields
  tier                String    @default("free") // 'free', 'premium'
  chatPassExpiry      DateTime? @map("chat_pass_expiry") @db.Timestamptz
  dailyChatCount      Int       @default(0) @map("daily_chat_count")
  dailyChatResetAt    DateTime? @map("daily_chat_reset_at") @db.Timestamptz
  spotlightCredits    Int       @default(0) @map("spotlight_credits")
  subscriptions       Subscription[]
  purchases           Purchase[]
  
  // Boost notification spam prevention
  lastBoostNotificationAt   DateTime? @map("last_boost_notification_at") @db.Timestamptz
  boostNotificationCount24h Int       @default(0) @map("boost_notification_count_24h")
  boostNotificationResetAt  DateTime? @map("boost_notification_reset_at") @db.Timestamptz

  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz

  @@map("users")
  @@index([deletedAt])
  @@index([googleId])
  @@index([verificationStatus])
  @@index([status])
  @@index([phoneNumber])
  @@index([boostNotificationCount24h]) // Fast spam filtering for boost targeting
}


model Want {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  category    String
  tradeMethod String   @map("trade_method") // 'cash', 'barter', 'both'
  condition   String   // 'new', 'used', 'any'
  country     String
  state       String
  notes       String?
  isFulfilled Boolean  @default(false) @map("is_fulfilled")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@map("wants")
  @@index([category]) // Speeds up "Find users who want Electronics"
}

model UserProfile {
  id            String    @id @default(uuid()) @db.Uuid
  userId        String    @unique @map("user_id") @db.Uuid
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  displayName   String?   @map("display_name")
  avatarUrl     String?   @map("avatar_url")
  countryId     Int?      @map("country_id")
  country       Country?  @relation(fields: [countryId], references: [id])
  regionId      Int?      @map("region_id")
  region        Region?   @relation(fields: [regionId], references: [id])
  bio           String?
  isVerified    Boolean   @default(false) @map("is_verified")
  lastLoginAt   DateTime? @map("last_login_at") @db.Timestamptz
  
  // Response Rate Tracking (for sellers)
  totalConversationsReceived    Int       @default(0) @map("total_conversations_received")
  conversationsRespondedWithin24h Int     @default(0) @map("conversations_responded_within_24h")
  responseRate                   Float    @default(100) @map("response_rate") // Percentage 0-100
  lastResponseRateUpdate         DateTime? @map("last_response_rate_update") @db.Timestamptz
  
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@map("user_profiles")
  @@index([displayName])
  @@index([regionId]) // Speeds up "Find users in Lagos"
}


// LOCATION & CATEGORIES

model Country {
  id        Int      @id @default(autoincrement())
  code      String   @unique @db.VarChar(2)
  name      String
  regions   Region[]
  listings  Listing[]
  profiles  UserProfile[]

  @@map("countries")
}

model Region {
  id        Int      @id @default(autoincrement())
  countryId Int      @map("country_id")
  country   Country  @relation(fields: [countryId], references: [id], onDelete: Cascade)
  name      String
  listings  Listing[]
  profiles  UserProfile[]

  @@map("regions")
}

model Category {
  id       Int       @id @default(autoincrement())
  slug     String    @unique
  name     String
  listings Listing[]

  @@map("categories")
}

// LISTINGS

enum ListingType {
  PHYSICAL
  SERVICE
}

model Listing {
  id                    String    @id @default(uuid()) @db.Uuid
  sellerId              String    @map("seller_id") @db.Uuid
  seller                User      @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  categoryId            Int       @map("category_id")
  category              Category  @relation(fields: [categoryId], references: [id])
  title                 String
  description           String?
  type                  ListingType @default(PHYSICAL)
  condition             String?   // 'new', 'used' - Optional for Services
  priceCents            BigInt?   @map("price_cents")
  currencyCode          String    @map("currency_code") @db.Char(3)
  allowCash             Boolean   @default(true) @map("allow_cash")
  allowBarter           Boolean   @default(false) @map("allow_barter")
  allowCashPlusBarter   Boolean   @default(false) @map("allow_cash_plus_barter")
  preferredBarterNotes  String?   @map("preferred_barter_notes")
  
  // Structured Barter Preferences (up to 3 items seller wants)
  barterPreference1     String?   @map("barter_preference_1") @db.VarChar(100)
  barterPreference2     String?   @map("barter_preference_2") @db.VarChar(100)
  barterPreference3     String?   @map("barter_preference_3") @db.VarChar(100)
  barterPreferencesOnly Boolean   @default(false) @map("barter_preferences_only")
  
  quantity              Int       @default(1)
  status                String    @default("active") // 'active','paused','sold','removed'
  views                 Int       @default(0)
  shippingMeetInPerson  Boolean   @default(true) @map("shipping_meet_in_person")
  shippingShipItem      Boolean   @default(false) @map("shipping_ship_item")
  countryId             Int?      @map("country_id")
  country               Country?  @relation(fields: [countryId], references: [id])
  regionId              Int?      @map("region_id")
  region                Region?   @relation(fields: [regionId], references: [id])
  createdAt             DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  images                ListingImage[]
  videoUrl              String?   @map("video_url") // Single video URL from Cloudinary
  barterOffers          BarterOffer[]
  barterOfferItems      BarterOfferItem[]
  cartItems             CartItem[]
  orderItems            OrderItem[]
  conversations         Conversation[]
  reports               Report[]
  recentlyViewed        RecentlyViewed[]
  reviews               Review[]
  promotions            PromotedListing[]
  isFeatured            Boolean   @default(false) @map("is_featured")

  // Distress Sale Fields
  isDistressSale        Boolean   @default(false) @map("is_distress_sale")
  distressReason        String?   @map("distress_reason") // 'urgent_cash', 'relocating', 'clearing_stock'
  distressExpiresAt     DateTime? @map("distress_expires_at") @db.Timestamptz

  // Monetization/Boost Fields
  isCrossListed         Boolean   @default(false) @map("is_cross_listed")
  spotlightExpiry       DateTime? @map("spotlight_expiry") @db.Timestamptz
  pushNotificationSent  Boolean   @default(false) @map("push_notification_sent")

  deletedAt             DateTime? @map("deleted_at") @db.Timestamptz

  @@map("listings")
  @@index([deletedAt])
  @@index([categoryId, status])
  @@index([sellerId, status])
  @@index([priceCents])
  @@index([createdAt])
  @@index([title])
}

model ListingImage {
  id        String   @id @default(uuid()) @db.Uuid
  listingId String   @map("listing_id") @db.Uuid
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  url       String
  sortOrder Int      @default(0) @map("sort_order")

  @@map("listing_images")
}

// BARTER OFFERS

model BarterOffer {
  id                String    @id @default(uuid()) @db.Uuid
  listingId         String    @map("listing_id") @db.Uuid
  listing           Listing   @relation(fields: [listingId], references: [id], onDelete: Cascade)
  buyerId           String    @map("buyer_id") @db.Uuid
  buyer             User      @relation("BuyerOffers", fields: [buyerId], references: [id], onDelete: Cascade)
  sellerId          String    @map("seller_id") @db.Uuid
  seller            User      @relation("SellerOffers", fields: [sellerId], references: [id], onDelete: Cascade)
  status            String    @default("pending") // 'pending','accepted','rejected','countered','cancelled'
  offeredCashCents  BigInt?   @default(0) @map("offered_cash_cents")
  currencyCode      String    @map("currency_code") @db.Char(3)
  message           String?
  expiresAt         DateTime? @map("expires_at") @db.Timestamptz
  
  // Trade Confirmation & Receipt
  listingOwnerConfirmedAt DateTime? @map("listing_owner_confirmed_at") @db.Timestamptz
  offerMakerConfirmedAt   DateTime? @map("offer_maker_confirmed_at") @db.Timestamptz
  receiptAvailableAt      DateTime? @map("receipt_available_at") @db.Timestamptz
  receiptGeneratedAt      DateTime? @map("receipt_generated_at") @db.Timestamptz
  receiptNumber           String?   @map("receipt_number")
  disputeStatus           String    @default("none") @map("dispute_status") // 'none', 'opened', 'resolved'

  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  items             BarterOfferItem[]
  cartItems         CartItem[]
  orders            Order[]
  orderItems        OrderItem[]
  conversations     Conversation[]

  @@map("barter_offers")
}

model BarterOfferItem {
  id                String      @id @default(uuid()) @db.Uuid
  barterOfferId     String      @map("barter_offer_id") @db.Uuid
  barterOffer       BarterOffer @relation(fields: [barterOfferId], references: [id], onDelete: Cascade)
  offeredListingId  String      @map("offered_listing_id") @db.Uuid
  offeredListing    Listing     @relation(fields: [offeredListingId], references: [id], onDelete: Restrict)
  quantity          Int         @default(1)

  @@map("barter_offer_items")
}

// CART & CHECKOUT

model Cart {
  id        String     @id @default(uuid()) @db.Uuid
  userId    String     @map("user_id") @db.Uuid
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    String     @default("active") // 'active','checked_out','abandoned'
  createdAt DateTime   @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime   @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  items     CartItem[]

  @@map("carts")
}

model CartItem {
  id            String       @id @default(uuid()) @db.Uuid
  cartId        String       @map("cart_id") @db.Uuid
  cart          Cart         @relation(fields: [cartId], references: [id], onDelete: Cascade)
  listingId     String       @map("listing_id") @db.Uuid
  listing       Listing      @relation(fields: [listingId], references: [id], onDelete: Cascade)
  quantity      Int          @default(1)
  dealType      String       @map("deal_type") // 'cash','barter','cash_plus_barter'
  barterOfferId String?      @map("barter_offer_id") @db.Uuid
  barterOffer   BarterOffer? @relation(fields: [barterOfferId], references: [id])
  createdAt     DateTime     @default(now()) @map("created_at") @db.Timestamptz

  @@map("cart_items")
  @@index([listingId]) // Speeds up category-from-cart targeting
}

// ORDERS & PAYMENTS

model Order {
  id                String       @id @default(uuid()) @db.Uuid
  buyerId           String       @map("buyer_id") @db.Uuid
  buyer             User         @relation("BuyerOrders", fields: [buyerId], references: [id], onDelete: Cascade)
  sellerId          String       @map("seller_id") @db.Uuid
  seller            User         @relation("SellerOrders", fields: [sellerId], references: [id], onDelete: Cascade)
  totalPriceCents   BigInt       @default(0) @map("total_price_cents")
  currencyCode      String       @map("currency_code") @db.Char(3)
  status            String       @default("pending") // 'pending','paid','cancelled','fulfilled'
  paymentStatus     String       @default("pending") @map("payment_status") // 'pending','paid','failed','refunded'
  shippingMethod    String       @map("shipping_method") // 'meet_in_person','ship_item'
  barterOfferId     String?      @map("barter_offer_id") @db.Uuid
  barterOffer       BarterOffer? @relation(fields: [barterOfferId], references: [id])
  createdAt         DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime     @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  items             OrderItem[]
  payments          Payment[]
  review            Review?
  escrowTransaction EscrowTransaction?
  disputes          Dispute[]

  deletedAt         DateTime? @map("deleted_at") @db.Timestamptz

  @@map("orders")
  @@index([deletedAt])
  @@index([buyerId, status])
  @@index([sellerId, status])
}

// ESCROW PROTECTION FOR DISTRESS SALES

model EscrowTransaction {
  id                  String    @id @default(uuid()) @db.Uuid
  orderId             String    @unique @map("order_id") @db.Uuid
  order               Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  // Amounts (all in cents)
  itemPriceCents      BigInt    @map("item_price_cents")
  protectionFeeCents  BigInt    @map("protection_fee_cents")  // Buyer pays this
  commissionCents     BigInt    @map("commission_cents")      // Platform commission
  totalPaidCents      BigInt    @map("total_paid_cents")      // itemPrice + protectionFee
  sellerReceivesCents BigInt    @map("seller_receives_cents") // itemPrice - commission
  currencyCode        String    @map("currency_code") @db.Char(3)
  
  // Escrow Status
  status              String    @default("pending") // pending, held, released, refunded, disputed, expired
  confirmationCode    String?   @map("confirmation_code")  // 6-digit code for buyer
  
  // Payment Provider Info
  paymentProvider     String    @default("mock") @map("payment_provider")  // mock, paystack, flutterwave
  paymentReference    String?   @map("payment_reference")
  paymentUrl          String?   @map("payment_url")  // Checkout URL if redirecting
  paymentStatus       String    @default("pending") @map("payment_status") // pending, success, failed
  
  // Timestamps
  paidAt              DateTime? @map("paid_at") @db.Timestamptz
  confirmedAt         DateTime? @map("confirmed_at") @db.Timestamptz
  releasedAt          DateTime? @map("released_at") @db.Timestamptz
  refundedAt          DateTime? @map("refunded_at") @db.Timestamptz
  expiresAt           DateTime  @map("expires_at") @db.Timestamptz  // 24hr window for confirmation
  
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  @@map("escrow_transactions")
  @@index([status])
  @@index([expiresAt])
  @@index([paymentReference])
}

model OrderItem {
  id            String       @id @default(uuid()) @db.Uuid
  orderId       String       @map("order_id") @db.Uuid
  order         Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  listingId     String       @map("listing_id") @db.Uuid
  listing       Listing      @relation(fields: [listingId], references: [id])
  quantity      Int          @default(1)
  priceCents    BigInt       @default(0) @map("price_cents")
  dealType      String       @map("deal_type") // 'cash','barter','cash_plus_barter'
  barterOfferId String?      @map("barter_offer_id") @db.Uuid
  barterOffer   BarterOffer? @relation(fields: [barterOfferId], references: [id])

  @@map("order_items")
}

model Payment {
  id            String   @id @default(uuid()) @db.Uuid
  orderId       String   @map("order_id") @db.Uuid
  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  amountCents   BigInt   @map("amount_cents")
  currencyCode  String   @map("currency_code") @db.Char(3)
  provider      String   // 'flutterwave','paystack','stripe','mock'
  providerRef   String?  @map("provider_ref")
  status        String   @default("pending") // 'pending','success','failed'
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@map("payments")
}

// MESSAGING

model Conversation {
  id            String       @id @default(uuid()) @db.Uuid
  listingId     String?      @map("listing_id") @db.Uuid
  listing       Listing?     @relation(fields: [listingId], references: [id])
  buyerId       String       @map("buyer_id") @db.Uuid
  buyer         User         @relation("BuyerConversations", fields: [buyerId], references: [id], onDelete: Cascade)
  sellerId      String       @map("seller_id") @db.Uuid
  seller        User         @relation("SellerConversations", fields: [sellerId], references: [id], onDelete: Cascade)
  barterOfferId String?      @map("barter_offer_id") @db.Uuid
  barterOffer   BarterOffer? @relation(fields: [barterOfferId], references: [id])
  
  // Response Rate Tracking
  sellerFirstResponseAt DateTime? @map("seller_first_response_at") @db.Timestamptz
  responseTracked       Boolean   @default(false) @map("response_tracked") // Has this been counted in stats?
  
  createdAt     DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime     @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  messages      Message[]

  @@map("conversations")
}

model Message {
  id             String       @id @default(uuid()) @db.Uuid
  conversationId String       @map("conversation_id") @db.Uuid
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String       @map("sender_id") @db.Uuid
  sender         User         @relation(fields: [senderId], references: [id], onDelete: Cascade)
  body           String
  messageType    String       @default("text") @map("message_type") // 'text','system'
  mediaUrl       String?      @map("media_url")
  mediaType      String?      @map("media_type") // 'image', 'video'
  isRead         Boolean      @default(false) @map("is_read")
  createdAt      DateTime     @default(now()) @map("created_at") @db.Timestamptz
  reports        Report[]

  @@map("messages")
}

// NOTIFICATIONS

model Notification {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String
  data      Json
  readAt    DateTime? @map("read_at") @db.Timestamptz
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz

  @@map("notifications")
}

// FRAUD REPORTING

model Report {
  id                String    @id @default(uuid()) @db.Uuid
  reporterId        String    @map("reporter_id") @db.Uuid
  reporter          User      @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)
  reportedUserId    String?   @map("reported_user_id") @db.Uuid
  reportedUser      User?     @relation("ReportedUser", fields: [reportedUserId], references: [id])
  listingId         String?   @map("listing_id") @db.Uuid
  listing           Listing?  @relation(fields: [listingId], references: [id])
  messageId         String?   @map("message_id") @db.Uuid
  message           Message?  @relation(fields: [messageId], references: [id])
  reason            String
  status            String    @default("open") // 'open','in_review','resolved','dismissed'
  evidenceImages    String[]  @default([]) @map("evidence_images")
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz
  resolvedAt        DateTime? @map("resolved_at") @db.Timestamptz
  resolvedByAdminId String?   @map("resolved_by_admin_id") @db.Uuid
  resolvedByAdmin   User?     @relation("AdminResolver", fields: [resolvedByAdminId], references: [id])
  appeals           Appeal[]  @relation("ReportAppeals")

  @@map("reports")
}

// RECENTLY VIEWED

model RecentlyViewed {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  listingId String   @map("listing_id") @db.Uuid
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  viewedAt  DateTime @default(now()) @map("viewed_at") @db.Timestamptz

  @@unique([userId, listingId])
  @@map("recently_viewed")
}

// REVIEWS & RATINGS

model Review {
  id            String   @id @default(uuid()) @db.Uuid
  rating        Int      // 1-5 stars
  comment       String?  @db.Text
  orderId       String   @unique @map("order_id") @db.Uuid
  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  reviewerId    String   @map("reviewer_id") @db.Uuid
  reviewer      User     @relation("ReviewsGiven", fields: [reviewerId], references: [id], onDelete: Cascade)
  revieweeId    String   @map("reviewee_id") @db.Uuid
  reviewee      User     @relation("ReviewsReceived", fields: [revieweeId], references: [id], onDelete: Cascade)
  listingId     String   @map("listing_id") @db.Uuid
  listing       Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  isPublic      Boolean  @default(true) @map("is_public")
  flagged       Boolean  @default(false)
  photoProof    String?  @map("photo_proof") // Required for negative reviews (rating <= 2)
  adminResponse String?  @map("admin_response") @db.Text
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@index([revieweeId])
  @@index([listingId])
  @@index([orderId])
  @@map("reviews")
}

// APPEALS

model Appeal {
  id              String    @id @default(uuid()) @db.Uuid
  userId          String    @map("user_id") @db.Uuid
  user            User      @relation("UserAppeals", fields: [userId], references: [id], onDelete: Cascade)
  reportId        String?   @map("report_id") @db.Uuid
  report          Report?   @relation("ReportAppeals", fields: [reportId], references: [id])
  reason          String    // Why they're appealing
  message         String    @db.Text // Detailed explanation
  evidenceImages  String[]  @default([]) @map("evidence_images") // Optional supporting evidence
  status          String    @default("pending") // 'pending','approved','rejected'
  adminMessage    String?   @map("admin_message") @db.Text // Admin's response
  reviewedByAdminId String? @map("reviewed_by_admin_id") @db.Uuid
  reviewedByAdmin User?     @relation("AdminReviewedAppeals", fields: [reviewedByAdminId], references: [id])
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  reviewedAt      DateTime? @map("reviewed_at") @db.Timestamptz

  @@map("appeals")
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// DISPUTES

model Dispute {
  id              String    @id @default(uuid()) @db.Uuid
  orderId         String    @map("order_id") @db.Uuid
  order           Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  reporterId      String    @map("reporter_id") @db.Uuid
  reporter        User      @relation("DisputeReporter", fields: [reporterId], references: [id], onDelete: Cascade)
  reason          String    // 'item_not_as_described', 'seller_no_show', 'buyer_no_show', 'fraud', 'other'
  description     String    @db.Text
  evidenceImages  String[]  @default([]) @map("evidence_images")
  status          String    @default("open") // 'open', 'under_review', 'resolved', 'rejected'
  resolution      String?   // 'full_refund', 'partial_refund', 'no_action', 'warning_issued'
  adminNotes      String?   @map("admin_notes") @db.Text
  resolvedById    String?   @map("resolved_by_id") @db.Uuid
  resolvedBy      User?     @relation("DisputeResolver", fields: [resolvedById], references: [id])
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  resolvedAt      DateTime? @map("resolved_at") @db.Timestamptz

  @@map("disputes")
  @@index([orderId])
  @@index([reporterId])
  @@index([status])
  @@index([createdAt])
}


// RBAC MODELS

model Role {
  id          String       @id @default(uuid()) @db.Uuid
  name        String       @unique // super_admin, admin, moderator, etc.
  description String?
  level       Int          @default(0) // Hierarchy level: 100=super, 80=admin, etc.
  isSystem    Boolean      @default(false) @map("is_system") // Cannot be deleted if true
  
  permissions Permission[]
  users       User[]

  createdAt   DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime     @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@map("roles")
}

model Permission {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @unique // e.g. 'user.create', 'report.resolve'
  group     String   // e.g. 'users', 'reports', 'settings'
  description String?

  roles     Role[]

  @@map("permissions")
}

model AuditLog {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  user         User     @relation("AuditLogUser", fields: [userId], references: [id])
  action       String   // e.g. 'ROLE_ASSIGNED', 'PERMISSION_UPDATED'
  targetUserId String?  @map("target_user_id") @db.Uuid
  targetUser   User?    @relation("AuditLogTarget", fields: [targetUserId], references: [id])
  details      Json?    // Store old/new values
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@map("audit_logs")
  @@index([action])
  @@index([createdAt])
}

model DeviceFingerprint {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  hash      String   // Stable hash
  userAgent String?  @map("user_agent")
  ipAddress String?  @map("ip_address")
  country   String?
  
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@map("device_fingerprints")
  @@index([hash])
  @@index([ipAddress])
  @@index([userId])
}

model BlockedIp {
  id        String   @id @default(uuid()) @db.Uuid
  ipAddress String   @unique @map("ip_address")
  reason    String
  expiresAt DateTime? @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  createdByAdminId String? @map("created_by_admin_id") @db.Uuid

  @@map("blocked_ips")
  @@index([ipAddress])
}

// PROMOTED LISTINGS

model PromotedListing {
  id          String   @id @default(uuid()) @db.Uuid
  listingId   String   @map("listing_id") @db.Uuid
  listing     Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  placement   String   // 'homepage', 'category', 'search', 'all'
  startDate   DateTime @map("start_date") @db.Timestamptz
  endDate     DateTime @map("end_date") @db.Timestamptz
  durationDays Int     @map("duration_days")
  priceCents  BigInt   @map("price_cents")
  
  status      String   @default("active") // 'active', 'expired', 'cancelled'
  
  createdById String   @map("created_by_id") @db.Uuid
  createdBy   User     @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  
  @@map("promoted_listings")
  @@index([listingId])
  @@index([status, endDate])
  @@index([placement, status])
}

// Email OTP Verification for Registration
model EmailVerification {
  id        String   @id @default(uuid()) @db.Uuid
  email     String
  otp       String   // 6-digit code
  expiresAt DateTime @map("expires_at") @db.Timestamptz
  verified  Boolean  @default(false)
  attempts  Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  
  @@index([email])
  @@index([email, otp])
  @@map("email_verifications")
}

// MONETIZATION MODELS

model Subscription {
  id              String    @id @default(uuid()) @db.Uuid
  userId          String    @map("user_id") @db.Uuid
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  status          String    @default("active") // 'active', 'cancelled', 'expired'
  startedAt       DateTime  @default(now()) @map("started_at") @db.Timestamptz
  expiresAt       DateTime  @map("expires_at") @db.Timestamptz
  paystackSubCode String?   @map("paystack_sub_code")
  paystackCustCode String?  @map("paystack_cust_code")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@map("subscriptions")
  @@index([userId])
  @@index([status, expiresAt])
}

model Purchase {
  id              String    @id @default(uuid()) @db.Uuid
  userId          String    @map("user_id") @db.Uuid
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  type            String    // 'chat_pass', 'cross_list', 'aggressive_boost', 'spotlight_3', 'spotlight_7', 'premium'
  amountCents     Int       @map("amount_cents")
  currency        String    @default("NGN")
  listingId       String?   @map("listing_id") @db.Uuid
  paystackRef     String?   @map("paystack_ref")
  status          String    @default("pending") // 'pending', 'completed', 'failed'
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz

  @@map("purchases")
  @@index([userId])
  @@index([paystackRef])
  @@index([status])
}
